import {Cite} from 'spectacle';
import {DarkSlide, CodeSlide} from './slides';

# Ansible without dropping a brick

---

# Who is this guy

- Lukas Sadzik <lukas.sadzik@sensiolabs.de>
- Software Developer & Trainer @ SensioLabsDE
- Automation Fan
- @ko_libri

<!--
 Question at first:

- who uses vagrant
- Who already used ansible
- who has to handle more than two/ten/twenty/hundret machines?

# This I have to say first:

- Code examples are for demonstration. You might see things that can and should solved different in a real environment. Als always with learning, the order is think first, then question everything, rethink and then try out.
//-->


---

# What is the problem this talk want to solve

- scaling
- maintenance
- documentation
- reviewability
- teamwork and knowledge sharing
- singe point of truth
- automation

---

# Tools to solve these problems

- Chef
- Puppet
- SaltStack
- Ansible (this is, what this talk is about)

---

# Lets have a quick look at ansible

- Open source (GPL) 
- available on github
- Maintained/owned by Redhat
- written in python
- configured with YAML files 

---

# How to install ansible

Via yor favourite/available package manager

```bash
# (pacman -Syu)/(apt-get/brew/yum/pip install) ansible
```


---

# PITFALL

There are a lot of installation methods mentioned on the installation guide. Just take the most easiest for you.
Do not install ansible via GIT, unless you know, what you are doing

---

# How does ansible work / the usual setup

## One control machine
This is the only one, that has ansible installed!

---

# How does ansible work / the usual setup
## Some managed machines

Only dependency is python (2 or 3, it does not matter anymore)

Accessable by the control machine (via SSH or whatever other auth mechanism ansible supports ;))

---

# The control machine

The only machine we interact with directly is the control machine.

It has ansible installed and our self written scripts checked out.

---

# The managed machines

We do not log in onto this machines manualy (in a perfect world, we would not have access to this machines)

The only need python (=> 2.7) or Python 3 (>= 3.5) installed

And, our control machine has to be able to connect to the managed machines.

---

# Assistested quickstart with Vagrant

The most easy way to try out ansible might be using vagrant with the `ansible_local` provisioner.

You got an already to use environment in a virtual machine you can play around with. You don't need to bother about installing ansible and creating an inventory.

So, our inital learning setup looks like this:

---

```ruby
# ./Vagrantfile
# -*- mode: ruby -*-
# vi: set ft=ruby :

Vagrant.configure("2") do |config|
    config.vm.box = "debian/stretch64"
    config.vm.host_name = "ansible-quickstart.foo"
    # this is the important stuff:
    config.vm.provision "ansible_local" do |ansible|
        ansible.playbook = "site.yml"
        ansible.verbose = true # optional, but just add it ;)
    end
end
```

---

```yaml
# ./site.yml
- hosts: all
  tasks:
    - name: Greet someone
      shell: echo 'Hello World'
```

---

```bash
$ vagrant up # to start the vm. 
$ vagrant provision # run the provisioning manually
```

(Provisioning is only executed when the box is created=

---

# Our first concepts of ansible

## Playbooks

A playbook is a YAML-file, that is executed by the `ansible-playbook` command.

It assigns tasks (and/or roles) to a hosts, where they should be applied.

---

# Our first concepts of ansible

## Tasks

A task is a single step during the provisioning. It can be theoretically anything, as long a module exists for the task.

---

# Some examples (with the belonging module-name)

- Ensure that file XXY exists with this content (`template`, `copy`)
- Ensure service ABC is running (`service`)
- Ensure user FOOBAR exists and has no sudo privilege (`user`)
- Deploy APP to PROD (`deploy_helper`)
- Run script TAKE_WORLD_LEADERSHIP (`shell`, `command`)
- Ensure this git repo is checked out and at the current commit of that branch (`git`)

---


# Rule:

Always name your tasks! Find unique and meaningfull short descriptions. for the task.


```bash
$ ansible-playbook site-yml --start-at-task="Greet someone"
```

---

# Tip:

```
$ ansible-playbook -v
# [...]
TASK [Greet someone] ***********************************************************
changed: [default] => {"changed": true, "cmd": "echo 'Hello World'", "delta": "0:00:00.001228", "end": "2019-05-04 20:45:25.043545", "rc": 0, "start": "2019-05-04 20:45:25.042317", "stderr": "", "stderr_lines": [], "stdout": "Hello World", "stdout_lines": ["Hello World"]}
```

```
$ ansible-playbook
# [...]
TASK [Greet someone] ***********************************************************
changed: [default]
```

